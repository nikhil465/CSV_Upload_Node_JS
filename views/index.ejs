<!-- views/index.ejs -->

<!DOCTYPE html>
<html>
<head>
    <title>CSV Upload and Display</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="header">CSV Upload and Display</h1>

        <form class="upload-form" action="/upload" method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
            <input type="file" name="csvfile" accept=".csv">
            <button type="submit">Upload CSV</button>
        </form>

        <div class="search-box">
            <label for="searchInput">Search by Column:</label>
            <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Search...">
        </div>

        <% if (selectedCsv) { %>
            <h2>Selected CSV: <%= selectedCsv.originalname %></h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <% tableHeaders.forEach((column) => { %>
                            <th>
                                <%= column %>
                                <button class="sort-button" onclick="sortTable('<%= column %>')">▲</button>
                                <button class="sort-button" onclick="sortTable('<%= column %>', true)">▼</button>
                            </th>
                        <% }); %>
                    </tr>
                </thead>
                <tbody>
                    <% const recordsPerPage = 100;
                       const totalPages = Math.ceil(selectedCsv.data.length / recordsPerPage);
                       const currentPage = req.query.page || 1;
                       const start = (currentPage - 1) * recordsPerPage;
                       const end = start + recordsPerPage;

                       selectedCsv.data.slice(start, end).forEach((row) => { %>
                        <tr>
                            <% row.forEach((cell) => { %>
                                <td><%= cell %></td>
                            <% }); %>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
            
            <div class="pagination">
                <% for (let page = 1; page <= totalPages; page++) { %>
                    <a href="?csvid=<%= selectedCsv._id %>&page=<%= page %>" class="<%= page === parseInt(currentPage) ? 'active' : '' %>"><%= page %></a>
                <% } %>
            </div>

            <div id="chart-container"></div>
        <% } %>
    </div>
    
    <script>
        google.charts.load('current', { packages: ['corechart'] });
        google.charts.setOnLoadCallback(() => {
            drawChart(<%- JSON.stringify(selectedCsv.data) %>);
        });
    </script>
    <script src="/js/main.js"></script>
    
</body>
</html>
